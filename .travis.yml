#filename:.travis.yml
dist: bionic
sudo: false
notifications:
  email: false
env:
  global:
  - REPO=tool
before_script:
- export TZ=Asia/Shanghai
script:
- mkdir -p $TRAVIS_BUILD_DIR/output
- mkdir -p $TRAVIS_BUILD_DIR/tmp
- wget -N --no-check-certificate -O ./tmp/gfwlist2dnsmasq.sh https://raw.githubusercontent.com/cokebar/gfwlist2dnsmasq/master/gfwlist2dnsmasq.sh
- wget -N --no-check-certificate -O ./output/all_cn_cidr.rsc https://ispip.clang.cn/all_cn_cidr.txt
- chmod +x ./tmp/gfwlist2dnsmasq.sh
- ./tmp/gfwlist2dnsmasq.sh -l -o ./output/gfwlist_domain.rsc
- sed -i 's/\./\\\\./g' ./output/gfwlist_domain.rsc
- sed -i 's/^/add regexp="(\\\\.|^)&/g' ./output/gfwlist_domain.rsc
- sed -i 's/$/&\\$" type=FWD forward-to=$gfwdns/g' ./output/gfwlist_domain.rsc
- sed -i '1 i:local gfwdns 10.10.0.1' ./output/gfwlist_domain.rsc
- sed -i '2 i/ip dns static' ./output/gfwlist_domain.rsc
- sed -i 's/^/add address=&/g' ./output/all_cn_cidr.rsc
- sed -i 's/$/& list=CN/g' ./output/all_cn_cidr.rsc
- sed -i '1 i/log info "Loading CN ipv4 address list"' ./output/all_cn_cidr.rsc
- sed -i '2 i/ip firewall address-list remove [/ip firewall address-list find list=CN]' ./output/all_cn_cidr.rsc
- sed -i '3 i/ip firewall address-list' ./output/all_cn_cidr.rsc
- DATE_TIME=$(date "+%Y-%m-%d %H:%M:%S")
- cd /tmp/
- git clone https://${GIT_USER}:${TOKEN}@github.com/${GIT_USER}/${REPO}.git --branch gh-pages --single-branch gh-pages > /dev/null 2>&1 || exit 1
- cd gh-pages || exit 1
- git config user.name "goodffd"
- git config user.email "goodffd@gmail.com"
- cp $TRAVIS_BUILD_DIR/output/* .
- git add -A
- git commit -a -m "Configuration Files Generated on [$DATE_TIME]"
- git push -fq origin gh-pages > /dev/null 2>&1 || exit 1
- echo -e "Uploaded files to gh-pages\n"
